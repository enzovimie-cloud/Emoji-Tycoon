<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Emoji Tycoon: v86 FIXED</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- CORE --- */
        :root { 
            --bg: #050505; --panel: #101015; --card: #191920; 
            --accent: #ff0055; --gold: #ffd700; --text: #ffffff; 
            --green: #2ecc71; --blue: #00ccff; --purple: #9b59b6; --orange: #ff9900;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        
        body { 
            background-color: #000; margin: 0; height: 100vh; width: 100vw; overflow: hidden; 
            display: flex; justify-content: center; align-items: center; 
            font-family: 'Rajdhani', sans-serif; color: var(--text); font-size: 16px;
        }

        #game-app { 
            width: 100%; max-width: 480px; height: 100%; 
            background: radial-gradient(circle at center, #1a1a2e 0%, #000 120%); 
            position: relative; display: flex; flex-direction: column; 
            box-shadow: 0 0 60px #000; overflow: hidden; z-index: 1;
        }

        /* --- VISUALS --- */
        .cyber-bg { 
            position: absolute; top:0; left:0; width:100%; height:100%; 
            background: repeating-linear-gradient(0deg, transparent 0, transparent 1px, rgba(255,255,255,0.02) 1px, rgba(255,255,255,0.02) 2px); 
            z-index:0; pointer-events:none; 
        }

        /* --- TOASTS --- */
        #toast-area { position: absolute; top: 110px; left: 50%; transform: translateX(-50%); width: 90%; z-index: 20000; pointer-events: none; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .toast { 
            background: #fff; color: #000; padding: 10px 20px; border-radius: 50px; 
            font-weight: 800; font-size: 0.85rem; box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
            display: flex; align-items: center; gap: 8px; border-left: 5px solid #333;
            animation: toastIn 0.3s forwards;
        }
        .toast.success { border-color: var(--green); background: #e8f5e9; color: #1b5e20; }
        .toast.error { border-color: var(--accent); background: #ffebee; color: #b71c1c; }
        .toast.premium { border-color: var(--purple); background: #f3e5f5; color: #4a148c; }
        .toast.fever { border-color: var(--orange); background: #fff3e0; color: #e65100; }
        .toast.fade-out { animation: toastOut 0.4s forwards; }
        @keyframes toastIn { from { opacity:0; transform:translateY(-20px); } to { opacity:1; transform:translateY(0); } }
        @keyframes toastOut { to { opacity:0; transform:translateY(-20px); } }

        /* --- HEADER --- */
        .header { background: rgba(15, 15, 22, 0.98); padding: 10px 15px; border-bottom: 1px solid #333; z-index: 20; flex-shrink: 0; backdrop-filter: blur(10px); }
        .top-row { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .settings-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0; margin-right: 10px; color: #888; transition:0.3s; }
        .settings-btn.spinning { animation: spinGear 0.5s ease-out; color: #fff; }
        @keyframes spinGear { 100% { transform: rotate(180deg); } }
        
        .money { color: var(--green); font-weight: 900; font-size: 1.6rem; letter-spacing: 1px; text-shadow: 0 0 15px rgba(0, 230, 118, 0.25); }
        .gems-pill { background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.4); color: var(--gold); padding: 4px 12px; border-radius: 20px; font-weight: 800; display: flex; align-items: center; gap: 5px; }
        
        /* --- NOTICIAS CORREGIDAS (T√©cnica Padding-Left 100%) --- */
        .news-bar { 
            background: #050505; 
            border-bottom: 1px solid #222; 
            height: 26px; 
            width: 100%; 
            overflow: hidden; 
            white-space: nowrap; /* Mantiene todo en una l√≠nea */
            position: relative;
            z-index: 15; 
            flex-shrink: 0; 
            box-sizing: border-box;
        }
        .news-text { 
            display: inline-block;
            padding-left: 100%; /* Esto empuja el texto fuera de la pantalla a la derecha */
            animation: scrollText 18s linear infinite; 
            
            font-size: 0.7rem; 
            color: #aaa; 
            font-weight: 700; 
            text-transform: uppercase; 
            line-height: 26px;
        }
        
        @keyframes scrollText { 
            0% { transform: translate3d(0, 0, 0); } 
            100% { transform: translate3d(-100%, 0, 0); } /* Mueve el 100% del ancho total (padding + texto) */
        }

        /* --- GAME ZONE --- */
        .game-zone { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden; min-height: 200px; }
        #main-emoji { font-size: 13vh; cursor: pointer; z-index: 5; transition: transform 0.1s; filter: drop-shadow(0 0 40px rgba(255,255,255,0.08)); margin-bottom: 10px; }
        .emoji-clicked { transform: scale(0.90) rotate(3deg) !important; }
        
        #shield-visual { position: absolute; top: -10%; left: -10%; width: 120%; height: 120%; border: 2px solid var(--blue); border-radius: 50%; opacity: 0; pointer-events: none; transition: opacity 0.5s; animation: spin 8s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .shield-active { opacity: 0.6 !important; }

        .status-container { width: 85%; text-align: center; z-index: 5; }
        .bar-wrapper { position: relative; margin-bottom: 6px; }
        .bar-bg { width: 100%; height: 14px; background: #111; border-radius: 8px; overflow: hidden; border: 1px solid #333; margin-bottom: 6px; position:relative; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.3s; }
        .xp-fill { background: linear-gradient(90deg, #0055ff, var(--blue)); }
        .fever-fill { background: linear-gradient(90deg, #ff8800, #ff0055); }
        .status-label { font-size: 0.65rem; color: #888; font-weight: 800; display: flex; justify-content: space-between; margin-bottom: 2px; }

        /* --- TABS --- */
        .tabs { display: flex; background: #080808; border-top: 1px solid #222; height: 75px; z-index: 30; padding-bottom: env(safe-area-inset-bottom); flex-shrink: 0; }
        .tab { flex: 1; background: none; border: none; color: #555; font-weight: 700; font-size: 0.65rem; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; transition: all 0.2s ease; overflow: hidden; }
        .tab span { font-size: 1.6rem; filter: grayscale(1) opacity(0.5); margin-bottom: 3px; transition: 0.2s; position: relative; z-index: 2; }
        
        .tab.active { background: radial-gradient(circle at bottom, rgba(255,255,255,0.05), transparent 70%); }
        .tab.active::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 3px; background: currentColor; box-shadow: 0 2px 10px currentColor; }
        .tab.active::before { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 45px; height: 45px; border-radius: 50%; filter: blur(15px); opacity: 0.5; z-index: 1; background: currentColor; }
        .tab.active span { filter: grayscale(0) opacity(1); transform: scale(1.15) translateY(-3px); text-shadow: 0 0 10px currentColor; }
        
        .tab:nth-child(1).active { color: var(--green); } 
        .tab:nth-child(2).active { color: var(--blue); } 
        .tab:nth-child(3).active { color: var(--orange); } 
        .tab:nth-child(4).active { color: var(--purple); } 
        .tab:nth-child(5).active { color: #fff; } 
        .tab-locked { opacity: 0.4; }
        .lock-icon { position: absolute; top: 10px; right: 18px; font-size: 0.6rem; background: #000; border-radius: 50%; padding: 2px; border: 1px solid #444; color: #fff; z-index: 5; }

        /* --- PANELES --- */
        .panel-container { height: 38%; background: var(--panel); overflow-y: auto; padding: 12px; padding-bottom: 80px; box-shadow: inset 0 10px 30px rgba(0,0,0,0.5); flex-shrink: 0; }
        .panel { display: none; animation: fadeIn 0.2s ease-out; }
        .panel.active { display: block; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        /* --- CARDS --- */
        .card { 
            background: var(--card); padding: 10px; margin-bottom: 8px; border-radius: 10px; 
            border: 1px solid #2a2a35; box-shadow: 0 4px 6px rgba(0,0,0,0.2); 
            display: flex; justify-content: space-between; align-items: center; 
            gap: 10px;
        }
        .card:active { transform: scale(0.99); }
        
        .card-left { 
            display: flex; align-items: center; gap: 12px; 
            flex-grow: 1; min-width: 0; 
        }
        
        .card-icon { font-size: 1.6rem; width: 45px; height: 45px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.03); border-radius: 10px; border: 1px solid rgba(255,255,255,0.08); }
        
        .card-info { display: flex; flex-direction: column; overflow: hidden; }
        .card-info b { display: block; color: #eee; font-size: 0.95rem; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
        .card-info small { color: #888; font-size: 0.7rem; font-weight: 600; white-space: nowrap; }
        
        .btn-buy { 
            background: linear-gradient(180deg, #3a3a40, #2a2a30); color: #777; border: 1px solid #444; 
            padding: 8px 10px; border-radius: 8px; font-weight: 800; cursor: pointer; 
            min-width: 80px; max-width: 95px; flex-shrink: 0; 
            font-family: 'Rajdhani', sans-serif; font-size: 0.8rem; box-shadow: 0 3px 0 #1a1a20; transition: 0.1s; 
        }
        .btn-buy.affordable { background: linear-gradient(180deg, #2ecc71, #27ae60); color: #fff; border-color: #2ecc71; box-shadow: 0 3px 0 #1e8449; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        .btn-buy.hacker-btn { background: linear-gradient(180deg, #9b59b6, #8e44ad); color: #fff; border-color: #8e44ad; box-shadow: 0 3px 0 #6c3483; }
        .btn-buy:active { top: 3px; box-shadow: none; }
        .btn-buy:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-mega { width: 100%; padding: 14px; border-radius: 10px; margin-top: 8px; font-size: 1rem; font-weight: 900; text-transform: uppercase; background: linear-gradient(45deg, #f1c40f, #f39c12); color: #000; border: 2px solid rgba(255,255,255,0.5); box-shadow: 0 0 15px rgba(241, 196, 15, 0.3); animation: pulseOffer 2s infinite; cursor: pointer; }
        @keyframes pulseOffer { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        .modal-btn { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: 900; margin-top: 10px; cursor: pointer; font-family: 'Rajdhani', sans-serif; font-size: 1rem; text-transform: uppercase; box-shadow: 0 4px 0 rgba(0,0,0,0.3); transition:0.1s; }
        .btn-green { background: var(--green); color: #000; box-shadow: 0 4px 0 #00b359; }
        .btn-red { background: var(--accent); color: #fff; box-shadow: 0 4px 0 #cc0044; }

        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); z-index: 15000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .popup { background: #16161e; width: 85%; max-width: 380px; padding: 25px; border-radius: 16px; border: 1px solid #333; text-align: center; position: relative; animation: popIn 0.3s; box-shadow: 0 20px 60px rgba(0,0,0,0.8); }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        .shop-toggle-container { display: flex; gap: 10px; margin-bottom: 12px; }
        .shop-toggle { flex: 1; padding: 8px; background: #222; border: 1px solid #333; color: #666; font-weight: bold; cursor: pointer; border-radius: 8px; transition: 0.3s; font-size: 0.9rem; }
        .shop-toggle.active { background: #2a2a35; border-color: var(--purple); color: #fff; box-shadow: 0 0 10px rgba(188,19,254,0.2); }

        .skins-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .skin-item { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; border: 1px solid #333; text-align: center; cursor: pointer; position:relative; }
        .skin-item.active { border-color: var(--green); background: rgba(0,255,136,0.15); }
        
        #wheel-canvas { width: 250px; height: 250px; margin: 0 auto; display: block; transition: transform 4s cubic-bezier(0.1, 0, 0.1, 1); border-radius:50%; }
        #lang-container { display: flex; gap: 15px; justify-content: center; margin-top: 30px; }
        .lang-card { background: rgba(255,255,255,0.1); border: 2px solid #444; padding: 15px; border-radius: 15px; cursor: pointer; transition: 0.2s; text-align: center; width: 100px; }
        .lang-card:hover { border-color: var(--green); background: rgba(0,255,136,0.1); transform: scale(1.05); }

        .artifact-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 15px; }
        .artifact { background: #000; border: 1px solid #333; border-radius: 8px; padding: 10px; opacity: 0.5; filter: grayscale(1); transition: 0.3s; text-align:center; }
        .artifact.unlocked { opacity: 1; filter: grayscale(0); border-color: var(--gold); box-shadow: 0 0 10px rgba(255,215,0,0.2); }
        
        .particle { position: absolute; font-weight: 900; pointer-events: none; animation: floatUp 0.8s forwards; font-size: 1.3rem; z-index: 10; text-shadow: 0 0 5px currentColor; }
        @keyframes floatUp { to { transform: translateY(-100px) rotate(20deg); opacity: 0; } }

        /* UFO ANIMATION */
        .ufo-fly { position: fixed; top: 15%; z-index: 12000; font-size: 3.5rem; animation: flyAcross 12s linear forwards; cursor: pointer; filter: drop-shadow(0 0 10px #0f0); pointer-events: auto; }
        @keyframes flyAcross { 0% { left: -100px; transform: rotate(-5deg); } 100% { left: 110vw; transform: rotate(5deg); } }
        
        /* POINTER DE RULETA */
        #pointer { 
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%); 
            width: 0; height: 0; 
            border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 25px solid var(--accent); 
            z-index: 10; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }

        /* MATRIX */
        #matrix-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,20,0,0.92); z-index:100; display:none; }
        #matrix-ui { position: absolute; top:20px; width:100%; text-align:center; z-index:102; display:none; pointer-events:none; }
        .matrix-title { color:#0f0; font-size:1.8rem; text-shadow:0 0 15px #0f0; font-weight:900; animation:blink 1s infinite; }
        .falling-item { position:absolute; font-weight:900; cursor:pointer; z-index:101; pointer-events:auto; animation:glowItem 0.5s infinite alternate; user-select:none; }
        @keyframes blink { 50% { opacity:0.5; } }
        @keyframes glowItem { from{text-shadow:0 0 5px currentColor;} to{text-shadow:0 0 15px currentColor;} }

        /* REAL AD BANNER */
        #ad-wrapper { width: 100%; height: 50px; background: #000; border-top: 1px solid #222; display: none; justify-content: center; align-items: center; flex-shrink: 0; z-index: 25; }
        
        /* Highlight oferta */
        .highlight-card { border: 2px solid var(--gold); box-shadow: 0 0 15px rgba(255,215,0,0.2); animation: pulseBorder 2s infinite; }
        @keyframes pulseBorder { 50% { border-color: #fff; box-shadow: 0 0 25px rgba(255,215,0,0.4); } }
    </style>
</head>
<body>

<div id="game-app">
    <div class="cyber-bg"></div>
    <div id="matrix-overlay"></div>
    <div id="matrix-ui"><div class="matrix-title">DIGITAL STORM DETECTED</div></div>
    <div id="toast-area"></div>

    <div id="start-screen" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:20000; display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <div style="font-size: 6rem; animation: floatIcon 3s infinite;">üíé</div>
        <h1 style="color:#fff; font-size:3rem; margin-bottom:5px;">EMOJI TYCOON</h1>
        <p style="color:#666; letter-spacing:3px; margin-bottom:40px;">v86 FIXED</p>
        
        <button id="btn-start-main" onclick="showLangSelector()" style="background:var(--green); padding:15px 60px; border:none; border-radius:50px; font-weight:900; font-size:1.5rem; cursor:pointer; box-shadow: 0 0 25px rgba(0,255,136,0.4); animation: pulse 2s infinite;">PLAY</button>
        
        <div id="lang-select" style="display:none; flex-direction:column; align-items:center;">
            <h3 style="color:#fff; margin-bottom:15px;">SELECT LANGUAGE</h3>
            <div id="lang-container">
                <div class="lang-card" onclick="setLang('es')"><div style="font-size:2rem;">üá™üá∏</div>Espa√±ol</div>
                <div class="lang-card" onclick="setLang('en')"><div style="font-size:2rem;">üá¨üáß</div>English</div>
            </div>
        </div>
    </div>
    <style>@keyframes floatIcon { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-15px);} } @keyframes pulse{0%{transform:scale(1);}50%{transform:scale(1.05);}100%{transform:scale(1);}}</style>

    <div class="header">
        <div class="top-row">
            <div style="display:flex; align-items:center;">
                <button class="settings-btn" id="btn-settings-icon" onclick="openSettings()">‚öôÔ∏è</button>
                <div style="font-weight:900; font-size:1.1rem; letter-spacing:1px;">EMOJI TYCOON</div>
            </div>
            <div class="gems-pill">üíé <span id="ui-gems">0</span></div>
        </div>
        <div class="top-row" style="margin-top:8px; align-items:flex-end;">
            <div class="money" id="ui-money">$0</div>
            <div style="font-size:0.8rem; color:#888; font-weight:bold;">+<span id="ui-pps">0</span>/s <span id="ui-chip-boost" style="color:var(--purple); font-weight:800;"></span></div>
        </div>
        <div style="width:100%; height:4px; background:#222; margin-top:8px; border-radius:2px; overflow:hidden;"><div id="threat-bar" style="height:100%; width:0%; background:var(--accent); transition:width 0.5s; box-shadow:0 0 10px var(--accent);"></div></div>
    </div>

    <div class="news-bar"><div class="news-text" id="news-text">...</div></div>

    <div class="game-zone">
        <div id="main-emoji-container" style="position:relative; z-index:5;">
            <div id="shield-visual"></div>
            <div id="main-emoji" onclick="doClick(event)">üë∂</div>
        </div>
        <div class="status-container">
            <div class="status-label"><span id="lbl-lvl">NIVEL 1</span> <span id="xp-text" style="color:#555;">0/2000</span></div>
            <div class="bar-bg"><div class="bar-fill xp-fill" id="xp-bar"></div></div>
            <div class="status-label" id="fever-text" style="color:var(--gold); margin-top:8px;">FIEBRE</div>
            <div class="bar-bg"><div class="bar-fill fever-fill" id="fever-bar"></div></div>
        </div>
    </div>

    <div id="ad-wrapper">
        <script type="text/javascript">
            atOptions = { 'key' : '92cf9b7506a2347b830d7ec0e9445744', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} };
        </script>
        <script type="text/javascript" src="//www.highperformanceformat.com/92cf9b7506a2347b830d7ec0e9445744/invoke.js"></script>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="tab('prod', this)"><span>üè≠</span><div id="lbl-prod">Prod</div></button>
        <button class="tab" onclick="tab('def', this)"><span>üõ°Ô∏è</span><div id="lbl-def">Def</div></button>
        <button class="tab" onclick="tab('btc', this)"><span>ü™ô</span><div id="lbl-crypto">Crypto</div></button>
        <button class="tab" onclick="tab('shop', this)"><span>üõí</span><div id="lbl-shop">Tienda</div></button>
        <button class="tab tab-locked" id="tab-world-btn" onclick="clickWorld(this)"><span>üåç</span><div id="world-lock-icon" class="lock-icon">üîí</div><div id="lbl-world">Mundo</div></button>
    </div>

    <div class="panel-container">
        <div id="prod" class="panel active"></div>
        <div id="def" class="panel"><div id="def-list"></div></div>
        
        <div id="btc" class="panel">
             <div style="background:#08080a; padding:15px; border-radius:15px; text-align:center; border:1px solid #333; margin-bottom:15px;">
                <div style="color:#888; font-size:0.75rem; letter-spacing:1px;" id="lbl-wallet">WALLET</div>
                <div style="font-size:2.5rem; color:#f39c12; font-weight:bold; font-family:monospace;" id="btc-ui">0</div>
                <div style="color:#aaa; font-size:0.9rem; margin-bottom:15px;">
                    1 BTC = <span id="btc-price-ui" style="font-weight:bold; color:#fff;">$50</span> <span id="btc-trend"></span>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="modal-btn" style="background:var(--orange); color:#000; margin:0;" onclick="mineBTC(event)" id="btn-mine">MINE</button>
                    <button class="modal-btn" style="background:var(--green); color:#000; margin:0;" onclick="sellBTC()" id="btn-sell">SELL</button>
                </div>
                <button id="btn-broker" class="btn-mega" onclick="activateBroker()">‚≠ê ACTIVAR IA TRADER</button>
            </div>
            <div style="font-weight:bold; color:var(--purple); border-bottom:1px solid #333; padding-bottom:5px;" id="lbl-dark">MERCADO NEGRO</div>
            <div id="dark-list"></div>
        </div>

        <div id="shop" class="panel">
            <div class="shop-toggle-container">
                <button class="shop-toggle active" id="btn-shop-items" onclick="showShopSection('items')">ITEMS</button>
                <button class="shop-toggle" id="btn-shop-skins" onclick="showShopSection('skins')">SKINS</button>
            </div>
            
            <div id="items-view">
                <div class="card highlight-card">
                    <div class="card-left"><div class="card-icon">üé°</div><div class="card-info"><b id="txt-wheel-btn">Ruleta</b><small>Gana premios</small></div></div>
                    <button class="btn-buy affordable" onclick="openWheel()">GO</button>
                </div>
                <div class="card" style="border-color:var(--purple);">
                    <div class="card-left"><div class="card-icon">üíé</div><div class="card-info"><b id="txt-pack">Pack Gemas</b><small>Ver Video</small></div></div>
                    <button class="btn-buy affordable" onclick="watchAdForGems()" id="btn-pack">VIDEO</button>
                </div>
                <div id="gem-list"></div>
            </div>
            <div id="skins-view" class="skins-grid" style="display:none;"></div>
        </div>

        <div id="world" class="panel">
            <div style="text-align:center; padding:10px; background:rgba(0,200,255,0.1); border:1px solid var(--blue); border-radius:10px; margin-bottom:15px; font-weight:bold; color:var(--blue);" id="lbl-missions">MISIONES</div>
            <button class="btn-mega" style="background:linear-gradient(45deg, #111, #333); border-color:var(--gold); color:var(--gold); margin-bottom:20px;" onclick="openMuseum()">üèõÔ∏è MUSEO DE ARTEFACTOS</button>
            <div id="mission-list"></div>
        </div>
    </div>

    <div id="settings-modal" class="overlay"><div class="popup" style="border-color:#666;"><h2 style="color:#fff;">AJUSTES</h2><div style="margin:20px 0;"><button id="btn-toggle-sfx" class="modal-btn" onclick="toggleSfx()">SONIDO</button></div><div style="border-top:1px solid #333; padding-top:15px;"><p id="prestige-info" style="font-size:0.8rem; color:#aaa; margin-bottom:10px;">...</p><button class="modal-btn" style="background:var(--purple); color:#fff;" onclick="doPrestige()">ASCENDER</button></div><button class="modal-btn" style="background:transparent; color:#888;" onclick="closeModals()">CERRAR</button></div></div>
    
    <div id="wheel-modal" class="overlay">
        <div class="popup" style="border-color:var(--accent); display:flex; flex-direction:column; align-items:center;">
            <h2 style="color:var(--accent);">RULETA</h2>
            <div style="width:300px; height:300px; position:relative; margin:20px 0;">
                <div id="pointer"></div> <canvas id="wheel-canvas" width="300" height="300"></canvas>
            </div>
            <button id="btn-spin" class="modal-btn btn-red" onclick="spinWheel()">GIRAR (10 üíé)</button>
            <button class="modal-btn" style="background:transparent; color:#888;" onclick="closeModals()">CERRAR</button>
        </div>
    </div>
    
    <div id="offline-modal" class="overlay"><div class="popup" style="border-color:var(--gold);"><h2 id="txt-off-t" style="color:var(--gold);"></h2><p id="txt-off-m" style="color:#aaa;"></p><h1 id="off-amt" style="color:#fff; font-size:2.5rem; margin:15px 0;">$0</h1><button id="btn-off-x2" class="modal-btn btn-green" onclick="claimOffline(true)">VIDEO x2</button><button id="btn-off-x1" class="modal-btn" style="background:transparent; border:none; color:#666; margin-top:15px; text-decoration:underline;" onclick="claimOffline(false)">Recoger normal</button></div></div>
    <div id="box-modal" class="overlay"><div class="popup" style="border-color:var(--purple);"><h2 id="txt-box-title" style="color:var(--purple);"></h2><p id="txt-box-msg" style="color:#aaa;"></p><button id="btn-box-vid" class="modal-btn btn-green" onclick="openBox(true)"></button><button id="btn-box-norm" class="modal-btn" style="background:#333; color:#aaa;" onclick="openBox(false)"></button></div></div>
    <div id="hacker-modal" class="overlay"><div class="popup" style="border-color:var(--accent);"><h2 id="txt-hacker-title" style="color:var(--accent);"></h2><p id="txt-hacker-msg" style="color:#aaa;"></p><h2 id="hacker-loss" style="color:#fff; font-size:2rem; margin:10px 0;">-$0</h2><button id="btn-hacker-vid" class="modal-btn btn-green" onclick="resolveHacker(true)"></button><button id="btn-hacker-acc" class="modal-btn" style="background:transparent; border:none; color:#666; text-decoration:underline;" onclick="resolveHacker(false)"></button></div></div>
    <div id="museum-modal" class="overlay"><div class="popup" style="border-color:var(--gold);"><h2 style="color:var(--gold);">MUSEO</h2><div class="artifact-grid" id="artifact-list"></div><button class="modal-btn" style="background:#333; color:#fff;" onclick="closeModals()">CERRAR</button></div></div>
    <div id="world-lock-modal" class="overlay"><div class="popup" style="border-color:var(--blue);"><div style="font-size:3rem;">üîí</div><h2 id="txt-world-title" style="color:var(--blue);">ZONA RESTRINGIDA</h2><div style="margin:20px 0; text-align:left;"><div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#aaa;"><span id="txt-req-gems">Gemas (100)</span><span id="lock-gems-val">0/100</span></div><div class="bar-bg"><div class="bar-fill xp-fill" id="lock-bar-gems"></div></div><div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#aaa; margin-top:10px;"><span id="txt-req-serv">Servidor (Nvl 1)</span><span id="lock-tech-val">NO</span></div><div class="bar-bg"><div class="bar-fill" style="background:var(--green)" id="lock-bar-tech"></div></div></div><button class="modal-btn" style="background:#333;" onclick="closeModals()">CERRAR</button></div></div>
</div>

<script>
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();
    let sfxEnabled = true;
    let lang = 'es';
    let rouletteInterval = null; 
    let isModalOpen = false; 

    // --- DATA ---
    const machinesDB = [ 
        {name: "Script", name_en: "Script", cost: 15, prod: 1, icon: "üë∂"}, 
        {name: "PC Gamer", name_en: "Gaming PC", cost: 250, prod: 10, icon: "üíª"}, 
        {name: "Servidor", name_en: "Server", cost: 5000, prod: 100, icon: "üñ•Ô∏è"}, 
        {name: "Cripto F√°brica", name_en: "Crypto Factory", cost: 12000, prod: 1400, icon: "üè≠"},
        {name: "Granja Cu√°ntica", name_en: "Quantum Farm", cost: 15000000, prod: 50000, icon: "üß†"},
        {name: "Nexo Alien√≠gena", name_en: "Alien Nexus", cost: 850000000, prod: 250000, icon: "üëΩ"} // NUEVA M√ÅQUINA
    ];
    // CORRECCI√ìN DE DESCRIPCIONES DE DEFENSA
    const defDB = [ 
        {name: "Antivirus", name_en: "Antivirus", cost: 500, desc: "-10% Amenaza", desc_en: "-10% Threat", icon: "üíä"}, 
        {name: "Firewall", name_en: "Firewall", cost: 5000, desc: "-25% Amenaza", desc_en: "-25% Threat", icon: "üî•"}, 
        {name: "Se√±uelo", name_en: "Decoy", cost: 50000, desc: "Convierte Ataque en BTC", desc_en: "Turn Attack to BTC", icon: "üí£"}, 
        {name: "Black ICE", name_en: "Black ICE", cost: 1000000, desc: "Roba $ al Hacker", desc_en: "Steal $ from Hacker", icon: "‚ò†Ô∏è"} 
    ];
    const darkItemsDB = [ {id: 'bot', name: "Bot", name_en: "Bot", cost: 50, desc: "Auto-clic", desc_en: "Auto-click", icon: "ü§ñ"}, {id: 'spy', name: "Esp√≠a", name_en: "Spy", cost: 100, desc: "Predice Precio", desc_en: "Predict Price", icon: "üëÅÔ∏è"}, {id: 'over', name: "Overclock", name_en: "Overclock", cost: 500, desc: "+10% Prod", desc_en: "+10% Prod", icon: "‚ö°"} ];
    const gemItemsDB = [ {id: 'coffee', name: "Caf√©", name_en: "Coffee", cost: 5, desc: "x2 Prod (1min)", icon: "‚òï"}, {id: 'shield', name: "Escudo", name_en: "Shield", cost: 15, desc: "Bloquea 1 ataque", desc_en: "Blocks 1 attack", icon: "üõ°Ô∏è"}, {id: 'warp', name: "Salto", name_en: "Warp", cost: 20, desc: "+2h Dinero", desc_en: "+2h Cash", icon: "‚è©"} ];
    const skinsDB = [ {id: "baby", icon: "üë∂", cost: 0, rarity: "common"}, {id: "cool", icon: "üòé", cost: 50, rarity: "rare"}, {id: "hacker", icon: "üòà", cost: 150, rarity: "rare"}, {id: "robot", icon: "ü§ñ", cost: 300, rarity: "epic"}, {id: "alien", icon: "üëΩ", cost: 500, rarity: "epic"}, {id: "king", icon: "üëë", cost: 1000, rarity: "legendary"} ];
    const missionsDB = [ {name: "Hack WiFi", name_en: "Hack WiFi", cost: 5000, reward: "+1 Gema/min", reward_en: "+1 Gem/min"}, {name: "Banco", name_en: "Bank Hack", cost: 500000, reward: "x2 Valor Dinero", reward_en: "x2 Cash Value"}, {name: "Matrix", name_en: "Matrix", cost: 1000000000, reward: "MODO DIOS", reward_en: "GOD MODE"} ];
    const artifactsDB = [ {id:'disk', icon:'üíæ', name:'Floppy Gold', desc:'-5% Costos'}, {id:'batt', icon:'üîã', name:'Quantum Batt', desc:'+10% Offline'}, {id:'dice', icon:'üé≤', name:'Glitch Dice', desc:'+5% Cr√≠tico'} ];
    const wheelPrizes = [ {label: "10üíé", val: 10, type: 'gem', color: '#9b59b6'}, {label: "50üíé", val: 50, type: 'gem', color: '#8e44ad'}, {label: "$1k", val: 1000, type: 'money', color: '#2ecc71'}, {label: "0üíé", val: 0, type: 'gem', color: '#333'}, {label: "$5k", val: 5000, type: 'money', color: '#27ae60'}, {label: "JACKPOT", val: 100, type: 'gem', color: '#f1c40f'} ];

    const dict = {
        es: { 
            offT: "¬°HAS VUELTO!", offM: "Tus m√°quinas trabajaron duro.", offV: "üé¨ VIDEO (x2)", offN: "Recoger normal", 
            boxT: "SUMINISTROS", boxM: "¬øQu√© paquete quieres abrir?", boxV: "üé¨ CAJA √âPICA", boxN: "Caja Com√∫n", 
            hackT: "¬°HACKER DETECTADO!", hackM: "Van a robar el 20% de tus fondos.", hackV: "üõ°Ô∏è SALVAR ($)", hackA: "Aceptar p√©rdida", 
            worldT: "ZONA RESTRINGIDA", reqG: "Gemas (100)", reqS: "Servidor (Nvl 1)", 
            close: "CERRAR", prod: "Prod", def: "Def", cry: "Crypto", shop: "Tienda", world: "Mundo", 
            lvl: "NIVEL", fever: "üî• ¬°FIEBRE DE CRIPTO! x2", 
            mine: "MINAR", sell: "VENDER", wallet: "CARTERA", broker: "‚≠ê ACTIVAR IA TRADER (3 MIN)", 
            gT: "‚ÑπÔ∏è GU√çA CRIPTO:", dark: "MERCADO NEGRO", upg: "üì¶ MEJORAS", 
            pack: "Pack Gemas", vid: "VIDEO (+10)", miss: "MISIONES GLOBALES", ready: "¬°LISTO!", 
            miss_ok: "Misi√≥n OK", bought: "¬°COMPRADO!", 
            wheelT: "RULETA SUERTE", wheelB: "GIRAR (10 üíé)", loadingAd: "CARGANDO ANUNCIO...", 
            txt_wheel: "Ruleta", txt_wheel_d: "Gana premios", txt_pack: "Pack Gemas", txt_pack_d: "+10 Gemas", 
            prop: "Propiedad: ",
            noGem: "üíé Gemas insuficientes",
            noCash: "‚õî Dinero insuficiente"
        },
        en: { 
            offT: "WELCOME BACK!", offM: "Your machines worked hard.", offV: "üé¨ VIDEO (x2)", offN: "Collect normal", 
            boxT: "SUPPLIES", boxM: "Which package do you want?", boxV: "üé¨ EPIC CRATE", boxN: "Common Crate", 
            hackT: "HACKER DETECTED!", hackM: "Stealing 20% of funds.", hackV: "üõ°Ô∏è SAVE MONEY", hackA: "Accept Loss", 
            worldT: "RESTRICTED AREA", reqG: "Gems (100)", reqS: "Server (Lvl 1)", 
            close: "CLOSE", prod: "Prod", def: "Def", cry: "Crypto", shop: "Shop", world: "World", 
            lvl: "LEVEL", fever: "üî• CRYPTO FEVER! x2", 
            mine: "MINE", sell: "SELL", wallet: "WALLET", broker: "‚≠ê ACTIVATE AI TRADER (3 MIN)", 
            gT: "‚ÑπÔ∏è CRYPTO GUIDE:", dark: "BLACK MARKET", upg: "üì¶ UPGRADES", 
            pack: "Gem Pack", vid: "VIDEO (+10)", miss: "GLOBAL MISSIONS", ready: "READY!", 
            miss_ok: "Mission OK", bought: "BOUGHT!", 
            wheelT: "LUCKY WHEEL", wheelB: "SPIN (10 üíé)", loadingAd: "LOADING AD...", 
            txt_wheel: "Lucky Wheel", txt_wheel_d: "Win Prizes", txt_pack: "Gem Pack", txt_pack_d: "+10 Gems", 
            prop: "Owned: ",
            noGem: "üíé Insufficient Gems", 
            noCash: "‚õî Insufficient Funds" 
        }
    };

    let game = { money: 0, gems: 20, btc: 0, machines: [0,0,0,0,0,0], security: [0,0,0,0], ownedSkins: ["baby"], currentSkin: "baby", missions: [0,0,0,0,0], artifacts: [], hasSpy:false, hasShield:false, overclock:0, lastLogin: Date.now(), worldUnlocked: false, level: 1, xp: 0, prestigeChips: 0 };
    let threat=0, btcPrice=20, nextPrice=25, pendingOffline=0, boostMult=1, brokerActive=false, fever=0, feverMode=false, nextUfoTime=Date.now()+120000;

    // --- REPAIR DATA ON LOAD (EmojiV86_Final) ---
    if(localStorage.getItem('EmojiV86_Final')) { 
        try { 
            let saved = JSON.parse(localStorage.getItem('EmojiV86_Final'));
            game = {...game, ...saved};
            // Asegurar compatibilidad con la nueva maquina (indice 5)
            if(!game.machines || game.machines.length < 6) { 
                // Migrar datos viejos
                let old = game.machines || [0,0,0,0,0];
                while(old.length < 6) old.push(0);
                game.machines = old;
            }
            if(!game.security || game.security.length < 4) game.security = [0,0,0,0];
            if(!game.missions || game.missions.length < 5) game.missions = [0,0,0,0,0];
            if(!game.artifacts) game.artifacts = [];
        } catch(e) { console.log("Save corrupted, reset"); }
    }

    function getText(key) { return dict[lang][key] || key; }
    function setLang(l) { 
        lang = l; 
        // CORRECCI√ìN AUDIO: Activar AudioContext al iniciar el juego
        if (audioCtx.state === 'suspended') audioCtx.resume();

        document.getElementById('start-screen').style.display='none'; 
        document.getElementById('ad-wrapper').style.display='flex'; 
        updateUI(); updateNews(); checkOffline(); 
        setInterval(updateNews, 5000); 
    }
    function showLangSelector() { document.getElementById('btn-start-main').style.display = 'none'; document.getElementById('lang-select').style.display = 'flex'; }
    
    // FUNCION DE NOTICIAS
    function updateNews() {
        const newsList = [
            {es: "EL BITCOIN SUBE COMO LA ESPUMA üöÄ", en: "BITCOIN SKYROCKETING üöÄ"},
            {es: "HACKERS INTENTAN ROBAR LA LUNA üåë", en: "HACKERS TRY TO STEAL MOON üåë"},
            {es: "TU IMPERIO CRECE SIN PARAR üí∞", en: "YOUR EMPIRE GROWS FAST üí∞"},
            {es: "NUEVO CHIP NEURONAL A LA VENTA üß†", en: "NEW NEURAL CHIP FOR SALE üß†"},
            {es: "LA BOLSA CAE, EL CRIPTO SUBE üìà", en: "STOCKS CRASH, CRYPTO UP üìà"},
            {es: "DETECTADA SE√ëAL ALIEN√çGENA üëΩ", en: "ALIEN SIGNAL DETECTED üëΩ"}
        ];
        let item = newsList[Math.floor(Math.random() * newsList.length)];
        let txt = lang === 'es' ? item.es : item.en;
        
        let el = document.getElementById('news-text');
        el.innerText = txt;
        
        // Reinicio "fuerte" de la animaci√≥n para asegurar que arranque desde la derecha
        el.style.animation = 'none';
        el.offsetHeight; /* trigger reflow */
        el.style.animation = 'scrollText 18s linear infinite';
    }

    function notify(m, type='success') { 
        const t = document.createElement('div'); 
        t.className = `toast ${type}`; 
        let icon='üîî'; 
        if(type=='success')icon='‚úÖ'; 
        if(type=='error')icon='‚õî'; 
        if(type=='premium')icon='üíé'; 
        if(type=='fever')icon='üî•'; 
        t.innerHTML = `<span>${icon}</span> ${m}`; 
        document.getElementById('toast-area').appendChild(t); 
        setTimeout(() => { t.classList.add('fade-out'); setTimeout(() => t.remove(), 400); }, 2000); 
    }
    
    function toggleSfx() { 
        sfxEnabled = !sfxEnabled; 
        const btn = document.getElementById('btn-toggle-sfx');
        if(sfxEnabled) { 
            btn.innerText = "ON (ENCENDER)"; btn.className = "modal-btn btn-green"; 
        } else { 
            btn.innerText = "OFF (APAGAR)"; btn.className = "modal-btn btn-red"; 
        } 
    }
    
    function playSfx(type, pitch=1) {
        if(!sfxEnabled || audioCtx.state==='suspended') return;
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;
        if(type==='tick') { osc.frequency.setValueAtTime(600, now); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.05); osc.start(now); osc.stop(now+0.05); } 
        else if(type==='catch') { osc.type = 'triangle'; osc.frequency.setValueAtTime(800, now); gain.gain.setValueAtTime(0.1, now); osc.start(now); osc.stop(now+0.1); } 
        else { osc.frequency.setValueAtTime(440*pitch, now); gain.gain.setValueAtTime(0.1, now); osc.start(); osc.stop(now+0.1); }
    }

    function openSettings() { 
        isModalOpen = true; 
        let chips = Math.floor(Math.sqrt(game.money / 100000));
        let msg = lang == 'es' ? "Ganar√°s: " : "Gain: ";
        document.getElementById('prestige-info').innerText = msg + chips + " Chips";
        document.getElementById('settings-modal').style.display = 'flex'; 
        document.getElementById('btn-settings-icon').classList.add('spinning');
        setTimeout(()=>document.getElementById('btn-settings-icon').classList.remove('spinning'), 500);
    }
    
    function closeModals() { 
        document.querySelectorAll('.overlay').forEach(o => o.style.display = 'none'); 
        isModalOpen = false; 
        if(rouletteInterval) { clearInterval(rouletteInterval); rouletteInterval = null; }
    }

    function doClick(e) {
        let emoji = document.getElementById('main-emoji');
        emoji.classList.remove('emoji-clicked'); void emoji.offsetWidth; emoji.classList.add('emoji-clicked');
        setTimeout(()=>emoji.classList.remove('emoji-clicked'), 100);

        let fMult = feverMode ? 5 : 1;
        let val = (1 + (getPPS() * 0.02)) * fMult;
        
        if(game.artifacts.includes('dice') && Math.random()<0.05) { val *= 5; notify("CRIT!", 'premium'); }

        game.money += val; game.xp += val;
        
        let req = game.level * 2000;
        if(game.xp >= req) { game.level++; game.xp=0; game.gems+=2; notify("NIVEL UP!", 'success'); }
        
        document.getElementById('xp-bar').style.width = Math.min((game.xp/req)*100, 100) + "%";
        document.getElementById('xp-text').innerText = Math.floor(game.xp) + " / " + req + " XP";
        document.getElementById('lbl-lvl').innerText = getText('lvl') + " " + game.level;
        
        playSfx('coin', 1.2);
        
        let p = document.createElement('div'); p.className='particle'; p.innerText = "+$"+fmt(val);
        p.style.left = e.clientX+'px'; p.style.top = e.clientY+'px'; p.style.color = 'var(--green)';
        document.body.appendChild(p); setTimeout(()=>p.remove(), 800);

        if(!feverMode) { fever+=5; if(fever>=100){fever=100;activateFever();} document.getElementById('fever-bar').style.width=fever+"%"; }
        updateUI();
    }

    function activateFever() {
        feverMode=true; 
        notify(getText('fever'), 'fever'); 
        document.getElementById('fever-text').style.opacity=1;
        let i = setInterval(()=>{
            fever-=1; document.getElementById('fever-bar').style.width=fever+"%";
            if(fever<=0){ clearInterval(i); feverMode=false; document.getElementById('fever-text').style.opacity=0; }
        }, 100);
    }

    function clickWorld(el) {
        if(game.worldUnlocked) tab('world', el);
        else {
            isModalOpen = true; 
            let gp = Math.min((game.gems/100)*100, 100);
            let tp = (game.machines[2] || 0) > 0 ? 100 : 0; 
            document.getElementById('lock-gems-val').innerText = game.gems + "/100";
            document.getElementById('lock-bar-gems').style.width = gp + "%";
            
            let tpText = tp === 100 ? (lang==='es'?'¬°LISTO!':'READY!') : "NO";
            document.getElementById('lock-tech-val').innerText = tpText;
            document.getElementById('lock-bar-tech').style.width = tp + "%";
            
            document.getElementById('txt-world-title').innerText = getText('worldT');
            document.getElementById('txt-req-gems').innerText = getText('reqG');
            document.getElementById('txt-req-serv').innerText = getText('reqS');

            if(gp===100 && tp===100) {
                game.worldUnlocked = true; notify("WORLD UNLOCKED!", 'success');
                document.getElementById('tab-world-btn').classList.remove('tab-locked');
                document.getElementById('world-lock-icon').style.display='none';
                tab('world', el);
                isModalOpen = false; 
            } else { document.getElementById('world-lock-modal').style.display = 'flex'; }
        }
    }

    function spinWheel() {
        if(game.gems < 10) { notify(getText('noGem'), 'error'); return; } 
        game.gems -= 10; document.getElementById('btn-spin').disabled = true;
        const canvas = document.getElementById('wheel-canvas');
        canvas.style.transition = 'transform 4s cubic-bezier(0.1, 0, 0.1, 1)';
        canvas.style.transform = `rotate(${Math.floor(Math.random()*360)+3600}deg)`;
        let d = 50; const tick = () => { playSfx('tick'); d*=1.1; if(d<500) rouletteInterval = setTimeout(tick,d); };
        tick();

        setTimeout(() => {
            document.getElementById('btn-spin').disabled = false;
            const p = wheelPrizes[Math.floor(Math.random()*6)];
            if(p.type === 'gem') { game.gems += p.val; notify(p.label, 'success'); } else { game.money += getPPS() * p.val; notify(p.label, 'success'); }
            updateUI(); canvas.style.transition='none'; canvas.style.transform='rotate(0deg)';
            closeModals();
        }, 4000);
    }
    
    function drawWheel() {
        const canvas = document.getElementById('wheel-canvas');
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        const radius = width / 2;
        const arc = Math.PI * 2 / wheelPrizes.length;
        ctx.clearRect(0, 0, width, height);
        wheelPrizes.forEach((p, i) => {
            const angle = i * arc;
            ctx.beginPath(); ctx.fillStyle = p.color; ctx.moveTo(radius, radius);
            ctx.arc(radius, radius, radius, angle, angle + arc); ctx.lineTo(radius, radius); ctx.fill();
            ctx.save(); ctx.translate(radius, radius); ctx.rotate(angle + arc / 2);
            ctx.textAlign = "right"; ctx.fillStyle = "#fff"; ctx.font = "bold 20px Arial";
            ctx.fillText(p.label, radius - 20, 10); ctx.restore();
        });
    }

    function updateUI() {
        document.getElementById('ui-money').innerText = "$" + fmt(game.money);
        document.getElementById('ui-gems').innerText = game.gems;
        document.getElementById('ui-pps').innerText = fmt(getPPS());
        document.getElementById('btc-ui').innerText = game.btc;
        document.getElementById('btc-price-ui').innerText = "$"+btcPrice;
        document.getElementById('main-emoji').innerText = skinsDB.find(s=>s.id==game.currentSkin).icon;
        if(game.prestigeChips > 0) document.getElementById('ui-chip-boost').innerText = "(AI x" + (1 + game.prestigeChips * 0.1).toFixed(1) + ")";

        let shieldEl = document.getElementById('shield-visual');
        if(game.hasShield) shieldEl.classList.add('shield-active'); else shieldEl.classList.remove('shield-active');

        let trendEl = document.getElementById('btc-trend');
        if(game.hasSpy) { trendEl.innerText = nextPrice > btcPrice ? " üîº" : " üîΩ"; trendEl.style.color = nextPrice > btcPrice ? "var(--green)" : "var(--accent)"; } else { trendEl.innerText = ""; }

        const t = dict[lang];
        ['prod','def','crypto','shop','world'].forEach(id => { let el = document.getElementById('lbl-'+id); if(el) el.innerText = t[id] || id; });
        document.getElementById('btn-broker').innerText = t.broker;
        document.getElementById('txt-hacker-title').innerText = t.hackT; document.getElementById('txt-hacker-msg').innerText = t.hackM;
        document.getElementById('btn-hacker-vid').innerText = t.hackV; document.getElementById('btn-hacker-acc').innerText = t.hackA;
        document.getElementById('txt-off-t').innerText = t.offT; document.getElementById('txt-off-m').innerText = t.offM;
        document.getElementById('btn-off-x2').innerText = t.offV; document.getElementById('btn-off-x1').innerText = t.offN;
        document.getElementById('txt-box-title').innerText = t.boxT; document.getElementById('txt-box-msg').innerText = t.boxM;
        document.getElementById('btn-box-vid').innerText = t.boxV; document.getElementById('btn-box-norm').innerText = t.boxN;
        document.getElementById('lbl-dark').innerText = t.dark;
        document.getElementById('txt-wheel-btn').innerText = t.txt_wheel;
        document.getElementById('txt-pack').innerText = t.txt_pack;
        document.getElementById('lbl-wallet').innerText = t.wallet;
        document.getElementById('btn-mine').innerText = t.mine;
        document.getElementById('btn-sell').innerText = t.sell;

        let h=""; 
        for(let i=0; i<machinesDB.length; i++){
            let m=machinesDB[i]; let c=Math.floor(m.cost*Math.pow(1.15, game.machines[i]||0)); 
            let n=lang=='es'?m.name:m.name_en; let afford=game.money>=c?'affordable':'';
            h+=`<div class="card"><div class="card-left"><div class="card-icon">${m.icon}</div><div class="card-info"><b>${n}</b><small style="color:var(--green)">+${fmt(m.prod)}/s</small><small style="color:#888; font-size:0.6rem">${getText('prop')}${game.machines[i]||0}</small></div></div><button class="btn-buy ${afford}" onclick="buyMachine(${i},${c})">$${fmt(c)}</button></div>`;
        }
        document.getElementById('prod').innerHTML=h;

        h=""; for(let i=0; i<defDB.length; i++){
            let d=defDB[i]; let n=lang=='es'?d.name:d.name_en; let ds=lang=='es'?d.desc:d.desc_en; 
            let owned=game.security[i]; let afford=(!owned && game.money>=d.cost)?'affordable':'';
            h+=`<div class="card"><div class="card-left"><div class="card-icon">${d.icon}</div><div class="card-info"><b>${n}</b><small>${ds}</small></div></div><button class="btn-buy ${afford}" onclick="${owned?'':`buyDef(${i})`}">${owned?'OK':'$'+fmt(d.cost)}</button></div>`;
        }
        document.getElementById('def-list').innerHTML=h;

        h=""; darkItemsDB.forEach(d=>{ 
            let c=d.id=='over'?500*(game.overclock+1):d.cost; let owned=(d.id=='bot'&&game.hasBot)||(d.id=='spy'&&game.hasSpy); let n=lang=='es'?d.name:d.name_en; let ds=lang=='es'?d.desc:d.desc_en; let afford=(!owned && game.btc>=c)?'affordable hacker-btn':'hacker-btn';
            h+=`<div class="card" style="border-color:#bc13fe;"><div class="card-left"><div class="card-icon">${d.icon}</div><div class="card-info"><b>${n}</b><small>${ds}</small></div></div><button class="btn-buy ${afford}" ${owned||game.btc<c?'disabled':''} onclick="buyDarkItem('${d.id}',${c})">${owned?'OK':c+' ‚Çø'}</button></div>`; 
        }); document.getElementById('dark-list').innerHTML=h;
        
        h=""; gemItemsDB.forEach(g=>{ let n=lang=='es'?g.name:g.name_en; let ds=lang=='es'?g.desc:g.desc_en; let afford=game.gems>=g.cost?'affordable':''; h+=`<div class="card"><div class="card-left"><div class="card-icon">${g.icon}</div><div class="card-info"><b>${n}</b><small>${ds}</small></div></div><button class="btn-buy ${afford}" onclick="buyGemItem('${g.id}',${g.cost})">${g.cost} üíé</button></div>`; }); document.getElementById('gem-list').innerHTML=h;
        h=""; skinsDB.forEach(s=>{ let owned=game.ownedSkins.includes(s.id); let active=game.currentSkin == s.id; let locked = !owned && game.gems < s.cost; let activeClass = active ? 'active' : (locked ? 'locked' : ''); h+=`<div class="skin-item ${s.rarity} ${activeClass}" onclick="buySkin('${s.id}',${s.cost})"><div style="font-size:2rem;">${s.icon}</div>${!owned ? `<span style="font-size:0.7rem; color:gold">${s.cost}üíé</span>` : ''}</div>`; }); document.getElementById('skins-view').innerHTML=h;
        h=""; missionsDB.forEach((m,i)=>{ let done=game.missions[i]; let can=game.money>=m.cost; let n=lang=='es'?m.name:m.name_en; let r=lang=='es'?m.reward:m.reward_en; let afford=(!done && can)?'affordable':''; h+=`<div class="card" style="border-left:4px solid var(--blue);"><div class="card-left"><div class="card-icon">üåç</div><div class="card-info"><b>${n}</b><small>${r}</small></div></div><button class="btn-buy ${afford}" ${done||!can?'disabled':''} onclick="doMission(${i})">${done?'OK':'$'+fmt(m.cost)}</button></div>`; }); document.getElementById('mission-list').innerHTML=h;
        h=""; artifactsDB.forEach(a=>{ let has = game.artifacts.includes(a.id); h+=`<div class="artifact ${has?'unlocked':''}"><div class="artifact-icon" style="font-size:2rem">${a.icon}</div><small style="color:#fff">${has?a.name:'???'}</small><br><span style="font-size:0.6rem; color:#888;">${has?a.desc:'LOCKED'}</span></div>`; }); document.getElementById('artifact-list').innerHTML=h;
    }

    function getPPS() { return ((game.machines[0]||0)*1 + (game.machines[1]||0)*10 + (game.machines[2]||0)*100 + (game.machines[3]||0)*1400 + (game.machines[4]||0)*50000 + (game.machines[5]||0)*250000) * (1 + (game.overclock||0)*0.1) * boostMult * (1+game.prestigeChips*0.1); }
    function fmt(n) { if(n<1000)return Math.floor(n); let s=["","k","M","B","T","Qa"]; let e=Math.floor(Math.log10(n)/3); return (n/Math.pow(1000,e)).toFixed(1)+s[e]; }
    function tab(id, el) { document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active')); document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); document.getElementById(id).classList.add('active'); el.classList.add('active'); }
    function showShopSection(id) { document.getElementById('items-view').style.display=id=='items'?'block':'none'; document.getElementById('skins-view').style.display=id=='skins'?'grid':'none'; }
    
    function buyMachine(i,c) { 
        if(game.money>=c){ 
            game.money-=c; game.machines[i]++; 
            updateUI(); playSfx('coin'); notify(getText('bought'), 'success'); 
            
            // PARTICULAS MINADO
            let rect = event.target.getBoundingClientRect(); 
            let p = document.createElement('div'); p.className='particle'; p.innerText = "+1"; p.style.color='#0f0'; 
            p.style.left = (rect.left+rect.width/2)+'px'; p.style.top = (rect.top)+'px'; 
            document.body.appendChild(p); setTimeout(()=>p.remove(), 800);
        } else {
             notify(getText('noCash'), 'error'); 
        }
    }
    
    function buyDef(i) { if(game.money>=defDB[i].cost && !game.security[i]) { game.money-=defDB[i].cost; game.security[i]=1; updateUI(); notify(getText('bought'), 'success'); } else { notify(getText('noCash'), 'error'); } }
    function buyGemItem(id,c) { if(game.gems>=c) { game.gems-=c; if(id=='coffee'){boostMult=2;setTimeout(()=>boostMult=1,60000);} if(id=='shield'){game.hasShield=true;} if(id=='warp'){game.money+=getPPS()*3600;} updateUI(); notify(getText('bought'), 'success'); } else notify(getText('noGem'), 'error'); }
    function buyDarkItem(id,c) { if(game.btc>=c){ game.btc-=c; if(id=='spy')game.hasSpy=true; if(id=='bot')game.hasBot=true; if(id=='over')game.overclock++; notify(getText('bought'), 'success'); updateUI(); } }
    function doMission(i) { let m=missionsDB[i]; if(game.money>=m.cost){ game.money-=m.cost; game.missions[i]=1; notify(getText('miss_ok'), 'success'); updateUI(); } }
    function buySkin(id,c) { if(game.ownedSkins.includes(id)) { game.currentSkin=id; updateUI(); } else if(game.gems>=c) { if(confirm('Buy?')) { game.gems-=c; game.ownedSkins.push(id); game.currentSkin=id; updateUI(); } } }
    
    function checkOffline() { if(Date.now()-game.lastLogin > 60000) { let v = getPPS() * ((Date.now()-game.lastLogin)/1000); if(v>0) { pendingOffline=v; document.getElementById('off-amt').innerText="$"+fmt(v); document.getElementById('offline-modal').style.display='flex'; } } }
    function claimOffline(x2) { if(x2) watchAd(()=>{game.money+=pendingOffline*2; closeModals(); updateUI();}); else {game.money+=pendingOffline; closeModals(); updateUI();} }
    function watchAdForGems() { watchAd(()=>{ game.gems+=10; notify("+10 GEMAS", 'success'); updateUI(); }); }
    
    // --- REAL AD LINK INTEGRATION ---
    function watchAd(cb) { 
        notify(getText('loadingAd'), 'warn'); 
        const url="https://www.effectivegatecpm.com/ttwcdab5?key=8d51779f7c6cbf2f752d275eb491f8dc"; 
        window.open(url, '_blank'); 
        setTimeout(()=>{ if(cb) cb(); }, 4000); 
    }
    
    function mineBTC(e) { 
        game.btc++; updateUI(); 
        let rect = e.target.getBoundingClientRect(); 
        let p = document.createElement('div'); p.className='particle'; p.innerText = "+1‚Çø"; p.style.color='#f39c12'; 
        p.style.left = (rect.left+rect.width/2)+'px'; p.style.top = (rect.top)+'px'; 
        document.body.appendChild(p); setTimeout(()=>p.remove(), 800); 
    }

    function sellBTC() { if(game.btc>0){ game.money+=game.btc*btcPrice; game.btc=0; updateUI(); } }
    function activateBroker() { watchAd(()=>{ brokerActive=true; notify("BROKER ON", 'success'); setTimeout(()=>brokerActive=false, 180000); }); }
    function openWheel() { isModalOpen=true; document.getElementById('wheel-modal').style.display='flex'; drawWheel(); }
    function doPrestige() { let c=Math.floor(Math.sqrt(game.money/100000)); if(c<1) { notify("NEED $100k+", 'error'); return; } if(confirm("RESET?")) { game.money=0; game.machines=[0,0,0,0,0,0]; game.xp=0; game.level=1; game.prestigeChips+=c; updateUI(); closeModals(); } }
    
    function resolveHacker(watch) { 
        if(watch){ watchAd(()=>{ threat=0; document.getElementById('threat-bar').style.width="0%"; closeModals(); notify("SALVADO!", 'success'); }); } 
        else { game.money*=0.8; threat=0; document.getElementById('threat-bar').style.width="0%"; closeModals(); notify("FONDOS PERDIDOS", 'error'); } 
    }
    function openBox(watch) { closeModals(); if(watch) watchAd(()=>{ let m = getPPS()*500 + 1000; game.money += m; notify("+$"+fmt(m), 'success'); }); else { let m = getPPS()*50; game.money += m; notify("+$"+fmt(m), 'success'); } updateUI(); }
    function openMuseum() { isModalOpen=true; updateUI(); document.getElementById('museum-modal').style.display='flex'; }
    function closeModals() { document.querySelectorAll('.overlay').forEach(o => o.style.display = 'none'); isModalOpen=false; if(rouletteInterval) { clearInterval(rouletteInterval); rouletteInterval = null; } }

    function startMatrixRain() {
        if(isModalOpen || document.querySelector('.overlay[style*="display: flex"]')) return; 

        document.getElementById('matrix-overlay').style.display = 'block'; document.getElementById('matrix-ui').style.display = 'block';
        let items = [{t:'üíæ', type:'artifact', id:'disk', prob:0.02}, {t:'üîã', type:'artifact', id:'batt', prob:0.02}, {t:'üé≤', type:'artifact', id:'dice', prob:0.02}, {t:'‚Çø', type:'btc', val:3, prob:0.1}, {t:'üí∞', type:'cash', val:50, prob:0.3}, {t:'0', type:'junk', val:1, prob:0.5}, {t:'1', type:'junk', val:1, prob:0.5}]; 
        let interval = setInterval(() => {
            let x = Math.random() * window.innerWidth;
            let r = Math.random(), accumulated = 0, chosen = items[5];
            for(let i of items) { accumulated += i.prob; if(r <= accumulated) { chosen = i; break; } }
            let div = document.createElement('div'); div.className = 'falling-item'; div.innerText = chosen.t; div.style.left = x + 'px'; div.style.top = '-30px'; div.style.fontSize = (chosen.type==='junk' ? '1.5rem' : '2.5rem'); div.style.color = (chosen.type==='artifact' ? '#ffd700' : (chosen.type==='btc' ? '#f39c12' : '#0f0'));
            const collect = (e) => { e.preventDefault(); e.stopPropagation(); div.remove(); playSfx('tick');
                if(chosen.type === 'artifact' && !game.artifacts.includes(chosen.id)) { game.artifacts.push(chosen.id); notify("NEW ARTIFACT!", 'premium'); }
                else if(chosen.type === 'btc') { game.btc += chosen.val; notify("+"+chosen.val+" BTC", 'success'); updateUI(); }
                else if(chosen.type === 'cash') { let m = getPPS()*chosen.val; game.money += m; notify("+$"+fmt(m), 'success'); }
                else { game.money += getPPS(); } 
            };
            div.addEventListener('mousedown', collect); div.addEventListener('touchstart', collect); document.body.appendChild(div);
            let pos = -30, speed = Math.random() * 3 + 2;
            let fall = setInterval(() => { pos += speed; div.style.top = pos + 'px'; if(pos > window.innerHeight) { clearInterval(fall); div.remove(); } }, 16);
        }, 300);
        setTimeout(() => { clearInterval(interval); document.getElementById('matrix-overlay').style.display = 'none'; document.getElementById('matrix-ui').style.display = 'none'; }, 12000);
    }
    
    // UFO FIX (CROSS SCREEN + SEMAFORO)
    function spawnUFO_Logic() { 
        if(isModalOpen || document.querySelector('.overlay[style*="display: flex"]')) return; // NO SALIR SI HAY POPUP

        if(Date.now()>nextUfoTime){ 
            let d=document.createElement('div'); d.className='ufo-fly'; d.innerText='üõ∏'; 
            document.body.appendChild(d); 
            d.onclick=(e)=>{e.stopPropagation(); d.remove(); isModalOpen=true; document.getElementById('box-modal').style.display='flex';}; 
            setTimeout(()=>d.remove(), 12000); nextUfoTime=Date.now()+(Math.random()*120000+120000); 
        } 
    }

    setInterval(() => {
        if(document.getElementById('hacker-modal').style.display==='flex') { isModalOpen=true; return; }
        game.money+=getPPS()/10;
        let red=1; if(game.security[0])red-=0.1; if(game.security[1])red-=0.25; 
        threat+=0.08*red; document.getElementById('threat-bar').style.width=threat+"%";
        if(threat>=100){ 
            threat=0; 
            if(game.security[2]){ 
                game.btc+=5; notify("SE√ëUELO! +5 BTC", 'success'); 
            } else if(game.security[3]) { // L√≥gica para Black ICE a√±adida
                let stolen = game.money*0.05; 
                game.money+=stolen; 
                notify("BLACK ICE: +$"+fmt(stolen), 'premium');
            } else if(game.hasShield){ 
                game.hasShield=false; notify("ESCUDO USADO", 'error'); 
            } else { 
                let l=Math.floor(game.money*0.2); 
                document.getElementById('hacker-loss').innerText="-$"+fmt(l); 
                isModalOpen=true; 
                document.getElementById('hacker-modal').style.display='flex'; 
            } 
        }
        if(game.hasBot && Math.random()<0.1) doClick({clientX:window.innerWidth/2, clientY:window.innerHeight/3});
        updateUI();
    }, 100);

    setInterval(() => { 
        oldPrice=btcPrice; btcPrice=nextPrice; nextPrice=Math.floor(Math.random()*55)+5; 
        if(brokerActive){ if(btcPrice<15&&game.money>=1000){game.money-=btcPrice; game.btc++; notify("ü§ñ COMPRA", 'success');} if(btcPrice>45&&game.btc>0){game.money+=btcPrice; game.btc--; notify("ü§ñ VENTA", 'success');} } 
    }, 4000);
    
    setInterval(() => { game.lastLogin=Date.now(); localStorage.setItem('EmojiV86_Final', JSON.stringify(game)); }, 5000);
    setInterval(spawnUFO_Logic, 1000); 
    
    setInterval(() => { if(Math.random() < 0.05) startMatrixRain(); }, 60000);

    toggleSfx(); toggleSfx(); 
</script>
</body>
</html>